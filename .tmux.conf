# Terminal settings
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-ghostty:Tc"
set -ga terminal-overrides ",xterm-256color*:Tc"

# Ghostty passthrough (for images/graphics)
set -g allow-passthrough on

# Undercurl support (for Neovim LSP diagnostics)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Extended keys (Ctrl+Shift combos)
set -g extended-keys on
set -as terminal-features ',xterm-ghostty:extkeys'

# Prefix key: Ctrl+a (easier than Ctrl+b)
unbind C-b
set -gw prefix C-a
bind a send-prefix

# Open new panes/windows in same directory
bind c new-window -c "#{pane_current_path}"
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Faster escape time (for vim)
set-option -sg escape-time 10
set-option -g focus-events on

# Window navigation (shift+arrow)
bind -n S-down new-window
bind -n S-left prev
bind -n S-right next
bind -n C-left swap-window -d -t -1
bind -n C-right swap-window -d -t +1

# Vim-like pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# History (large for Claude output)
set -g history-limit 100000

# Renumber windows when one closes (no gaps)
set -g renumber-windows on

# Quick config reload
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Longer display time for messages
set -g display-time 2000
set -g display-panes-time 2000

# Sync tmux window name to terminal (Ghostty tab) title
set -g set-titles on
# Only show command if not a shell/pager, with emoji indicators for AI/editors
set -g set-titles-string "#S:#W#{?#{m/r:^(fish|bash|zsh|sh|less|more|cat)$,#{pane_current_command}},,#{?#{m/r:^(claude|codex|cursor-cli),#{pane_current_command}}, ü§ñ,#{?#{m/r:^(nvim|vim|code|cursor)$,#{pane_current_command}}, ‚å®Ô∏è,:#{pane_current_command}}}}"

# Vi-style copy mode
# prefix+[ to enter, v to select, y to yank to clipboard
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
# Rectangle/block selection (prefix+[ then C-v)
bind -T copy-mode-vi C-v send -X rectangle-toggle
# Copy line (Y)
bind -T copy-mode-vi Y send -X select-line \; send -X copy-pipe-and-cancel "pbcopy"
# Copy to end of line (D like vim)
bind -T copy-mode-vi D send -X copy-end-of-line-and-cancel \; run "tmux save-buffer - | pbcopy"
# Incremental search (/ forward, ? backward)
bind -T copy-mode-vi / command-prompt -i -p "(search down)" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "(search up)" "send -X search-backward-incremental \"%%%\""
# Quick scroll (half page with C-u/C-d like vim)
bind -T copy-mode-vi C-u send -X halfpage-up
bind -T copy-mode-vi C-d send -X halfpage-down

# Quick search for code blocks (prefix + ` to find ```)
bind ` copy-mode \; send-keys -X search-backward '```'

# Auto-rename windows to current directory
setw -g automatic-rename-format "#{b:pane_current_path}"

# ============================================================================
# Claude / Development Workflows
# ============================================================================

# Claude popup (prefix + C) - quick queries without disrupting layout
bind C display-popup -E -w 85% -h 85% -d "#{pane_current_path}" "claude"

# "go" prefix for layouts (prefix + g, then key)
bind g switch-client -T go-table

# Layout: Editor + Claude side-by-side (prefix + g c)
# Opens nvim on left (60%), Claude on right (40%)
bind -T go-table c new-window -c "#{pane_current_path}" \; \
    send-keys "nvim ." Enter \; \
    split-window -h -l 40% -c "#{pane_current_path}" \; \
    send-keys "claude" Enter \; \
    select-pane -L

# Layout: 2x2 dev grid (prefix + g d)
# +-------------+-------------+
# |   Server    |    Shell    |
# +-------------+-------------+
# |   Claude    |    Nvim     |
# +-------------+-------------+
bind -T go-table d new-window -c "#{pane_current_path}" \; \
    split-window -h -c "#{pane_current_path}" \; \
    split-window -v -c "#{pane_current_path}" \; \
    send-keys "nvim ." Enter \; \
    select-pane -t 0 \; \
    split-window -v -c "#{pane_current_path}" \; \
    send-keys "claude" Enter \; \
    select-pane -t 0

# Layout: Claude only in dedicated window (prefix + g C)
bind -T go-table C new-window -c "#{pane_current_path}" "claude"

# fzf popup for all file:line references in scrollback (prefix + f)
bind f run-shell "$HOME/.dotfiles/bin/tmux-fzf-files"

# ============================================================================
# Plugins
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'Morantron/tmux-fingers'

# tmux-fingers: press prefix+F to highlight file:line patterns, then press hint to act
set -g @fingers-key F
set -g @fingers-pattern-0 '[a-zA-Z0-9_./\-]+\.[a-zA-Z]+:[0-9]+'
set -g @fingers-ctrl-action "xargs -I {} tmux run-shell '$HOME/.dotfiles/bin/tmux-open-in-nvim {}'"

# Continuum settings (auto-save/restore sessions)
set -g @continuum-restore 'on'
set -g @continuum-boot 'off'
set -g @continuum-boot-options 'ghostty,fullscreen'

# ============================================================================
# Theme (Poimandres-inspired)
# ============================================================================

set -g status "on"
set -g status-justify "left"
set -g status-style "none,bg=default"
set -g status-left-style "none"
set -g status-left-length "100"
set -g status-right-style "none"
set -g status-right-length "100"

# Pane borders
set -g pane-border-style "fg=#33394a,bg=default"
set -g pane-active-border-style "fg=#404350,bg=default"
set -g pane-border-status bottom
set -g pane-border-format ""

# Messages
set -g message-style "fg=brightwhite,bg=default"
set -g message-command-style "fg=brightwhite,bg=default"

# Window status
setw -g window-status-activity-style "none"
setw -g window-status-separator " "
setw -g window-status-style "none,fg=brightwhite,bg=default"

# Status bar
set -g status-left "#[fg=#5de4c7,bg=default,bold]#S #[fg=brightwhite,bg=default,nobold,nounderscore,noitalics]"
set -g status-right "#[fg=#868cad,bg=default]%I:%M%p #[fg=#868cad,bg=default] %m/%d/%Y "
# Use #W for window name, only show command if not a shell/pager
# ü§ñ for AI agents, ‚å®Ô∏è for editors
set -g window-status-format '#[fg=#5fb3a1,bg=default] #I#[fg=#868cad,bg=default] #W#{?#{m/r:^(fish|bash|zsh|sh|less|more|cat)$,#{pane_current_command}},,#{?#{m/r:^(claude|codex|cursor-cli),#{pane_current_command}}, ü§ñ,#{?#{m/r:^(nvim|vim|code|cursor)$,#{pane_current_command}}, ‚å®Ô∏è,:#{pane_current_command}}}} '
set -g window-status-current-format '#[fg=#5de4c7,bg=default] #I#[fg=#ffffff,bg=default] #W#{?#{m/r:^(fish|bash|zsh|sh|less|more|cat)$,#{pane_current_command}},,#{?#{m/r:^(claude|codex|cursor-cli),#{pane_current_command}}, ü§ñ,#{?#{m/r:^(nvim|vim|code|cursor)$,#{pane_current_command}}, ‚å®Ô∏è,:#{pane_current_command}}}} '
set -g status-interval 5

# ============================================================================
# Initialize TPM (keep at bottom)
# ============================================================================

run -b '~/.tmux/plugins/tpm/tpm'
