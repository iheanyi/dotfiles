#!/bin/bash
# Create tmux layouts for development workflows
# Usage: tmux-layout <layout> [directory] [--new-window] [--yolo]
#
# Layouts:
#   claude    - Editor (60%) + Claude (40%) side-by-side
#   dev       - 2x2 grid: Server | Shell / Claude | Nvim
#
# Options:
#   --new-window    Force creating a new window (don't convert current)
#   --yolo          Use claude --dangerously-skip-permissions

set -e

layout="${1:-claude}"
shift || true

# Parse args
dir=""
force_new=false
yolo=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --new-window|-n)
            force_new=true
            shift
            ;;
        --yolo|-y)
            yolo=true
            shift
            ;;
        *)
            dir="$1"
            shift
            ;;
    esac
done

# Build claude command with optional yolo indicator
claude_cmd="claude"
if [[ "$yolo" == true ]]; then
    # Show visual indicator and run yolo mode
    claude_cmd="printf '\\033[1;33m⚠️  YOLO MODE\\033[0m\\n' && claude --dangerously-skip-permissions"
fi

# Default to current pane's directory
if [[ -z "$dir" ]]; then
    dir="$(tmux display -p '#{pane_current_path}')"
fi

# Check if we should convert current window or create new
pane_count=$(tmux display -p '#{window_panes}')
should_convert=false

if [[ "$pane_count" -eq 1 ]] && [[ "$force_new" == false ]]; then
    should_convert=true
fi

case "$layout" in
    claude|c)
        if [[ "$should_convert" == true ]]; then
            # Convert current pane: split and set up
            tmux split-window -h -l 40% -c "$dir"
            tmux send-keys "$claude_cmd" Enter
            tmux select-pane -L
            tmux send-keys "nvim ." Enter
        else
            # New window
            tmux new-window -c "$dir"
            tmux send-keys "nvim ." Enter
            tmux split-window -h -l 40% -c "$dir"
            tmux send-keys "$claude_cmd" Enter
            tmux select-pane -L
        fi
        ;;

    dev|d)
        # 2x2 grid: Server | Shell / Claude | Nvim
        if [[ "$should_convert" == true ]]; then
            # Convert current pane
            tmux split-window -h -c "$dir"           # Shell (right)
            tmux split-window -v -c "$dir"           # Nvim (bottom right)
            tmux send-keys "nvim ." Enter
            tmux select-pane -t 0
            tmux split-window -v -c "$dir"           # Claude (bottom left)
            tmux send-keys "$claude_cmd" Enter
            tmux select-pane -t 0                    # Back to Server (top left)
        else
            # New window
            tmux new-window -c "$dir"
            tmux split-window -h -c "$dir"
            tmux split-window -v -c "$dir"
            tmux send-keys "nvim ." Enter
            tmux select-pane -t 0
            tmux split-window -v -c "$dir"
            tmux send-keys "$claude_cmd" Enter
            tmux select-pane -t 0
        fi
        ;;

    *)
        echo "Unknown layout: $layout"
        echo "Available: claude (c), dev (d)"
        exit 1
        ;;
esac
