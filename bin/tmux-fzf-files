#!/bin/bash
# Fuzzy find all file:line references in tmux scrollback
# Opens selected file in nvim via tmux-open-in-nvim

# Capture scrollback (last 10000 lines)
scrollback=$(tmux capture-pane -p -S -10000)

# Extract file:line patterns, dedupe
files=$(echo "$scrollback" | \
    grep -oE '[a-zA-Z0-9_./-]+\.[a-zA-Z]+:[0-9]+' | \
    sort -u)

if [[ -z "$files" ]]; then
    tmux display-message "No file:line references found in scrollback"
    exit 0
fi

# Preview script (must use bash explicitly since user shell may be fish)
preview_cmd='bash -c '\''
    file=$(echo "$1" | cut -d: -f1)
    line=$(echo "$1" | cut -d: -f2)
    if command -v bat >/dev/null; then
        bat --color=always --highlight-line="$line" --line-range="$((line > 5 ? line - 5 : 1)):$((line + 15))" "$file" 2>/dev/null || echo "File not found: $file"
    else
        head -n "$((line + 15))" "$file" 2>/dev/null | tail -n 20 || echo "File not found: $file"
    fi
'\'' _ {}'

# fzf select with preview
selected=$(echo "$files" | \
    fzf-tmux -p 80%,80% \
        --preview "$preview_cmd" \
        --preview-window=right:60%:wrap \
        --header="Select file:line to open in nvim"
)

if [[ -n "$selected" ]]; then
    # Open in nvim via helper script
    "$HOME/.dotfiles/bin/tmux-open-in-nvim" "$selected"
fi
